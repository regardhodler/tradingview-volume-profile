// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © tradingview-volume-profile

//@version=6
indicator("Volume Profile", overlay=true, max_boxes_count=500, max_lines_count=50)

// ── Inputs ──────────────────────────────────────────────────────────────────
lookback        = input.int(200, "Lookback Period", minval=10, maxval=5000)
numRows         = input.int(24, "Number of Rows", minval=4, maxval=100)
profileWidth    = input.int(50, "Profile Width (bars)", minval=10, maxval=200)
valueAreaPercent = input.float(70.0, "Value Area %", minval=50.0, maxval=90.0)

buyColor        = input.color(color.new(color.green, 40), "Buy Volume Color")
sellColor       = input.color(color.new(color.red, 40), "Sell Volume Color")
pocColor        = input.color(color.yellow, "POC Line Color")
valueAreaBgColor = input.color(color.new(color.blue, 85), "Value Area Color")

// ── Main logic — only on the last bar ───────────────────────────────────────
if barstate.islast
    // Find price range over lookback
    highestHigh = ta.highest(high, lookback)
    lowestLow   = ta.lowest(low, lookback)
    rowHeight   = (highestHigh - lowestLow) / numRows

    if rowHeight > 0
        // Initialize volume arrays
        buyVol  = array.new_float(numRows, 0.0)
        sellVol = array.new_float(numRows, 0.0)

        // Accumulate volume into bins
        for i = 0 to lookback - 1
            midPrice = (high[i] + low[i]) / 2.0
            bin = math.floor((midPrice - lowestLow) / rowHeight)
            bin := math.min(bin, numRows - 1)
            bin := math.max(bin, 0)

            if close[i] > open[i]
                array.set(buyVol, bin, array.get(buyVol, bin) + volume[i])
            else
                array.set(sellVol, bin, array.get(sellVol, bin) + volume[i])

        // Find max total volume (for scaling) and POC bin
        maxVol  = 0.0
        pocBin  = 0
        totalVol = 0.0

        for i = 0 to numRows - 1
            binTotal = array.get(buyVol, i) + array.get(sellVol, i)
            totalVol += binTotal
            if binTotal > maxVol
                maxVol := binTotal
                pocBin := i

        // Calculate Value Area — expand outward from POC
        vaVolume    = array.get(buyVol, pocBin) + array.get(sellVol, pocBin)
        vaThreshold = totalVol * (valueAreaPercent / 100.0)
        vaLow       = pocBin
        vaHigh      = pocBin

        while vaVolume < vaThreshold and (vaLow > 0 or vaHigh < numRows - 1)
            upVol   = vaHigh < numRows - 1 ? array.get(buyVol, vaHigh + 1) + array.get(sellVol, vaHigh + 1) : 0.0
            downVol = vaLow > 0 ? array.get(buyVol, vaLow - 1) + array.get(sellVol, vaLow - 1) : 0.0

            if upVol >= downVol and vaHigh < numRows - 1
                vaHigh  += 1
                vaVolume += upVol
            else if vaLow > 0
                vaLow   -= 1
                vaVolume += downVol
            else if vaHigh < numRows - 1
                vaHigh  += 1
                vaVolume += upVol
            else
                break

        // ── Drawing ─────────────────────────────────────────────────────────
        // Clear previous drawings
        aBoxes = box.all
        for i = 0 to array.size(aBoxes) - 1
            box.delete(array.get(aBoxes, i))

        aLines = line.all
        for i = 0 to array.size(aLines) - 1
            line.delete(array.get(aLines, i))

        // Profile anchors: draw leftward from current bar
        rightBar = bar_index
        leftBar  = bar_index - profileWidth

        // Draw volume boxes per bin
        for i = 0 to numRows - 1
            binBottom = lowestLow + i * rowHeight
            binTop    = binBottom + rowHeight
            bv = array.get(buyVol, i)
            sv = array.get(sellVol, i)
            binTotal  = bv + sv

            if binTotal > 0 and maxVol > 0
                totalWidth = math.round(profileWidth * (binTotal / maxVol))
                buyWidth   = binTotal > 0 ? math.round(totalWidth * (bv / binTotal)) : 0
                sellWidth  = totalWidth - buyWidth

                // Green (buy) box — starts at left edge
                if buyWidth > 0
                    box.new(leftBar, binTop, leftBar + buyWidth, binBottom, border_color=buyColor, bgcolor=buyColor)

                // Red (sell) box — stacked next to green
                if sellWidth > 0
                    sellLeft = leftBar + buyWidth
                    box.new(sellLeft, binTop, sellLeft + sellWidth, binBottom, border_color=sellColor, bgcolor=sellColor)

        // Draw Value Area shading
        vaPriceBottom = lowestLow + vaLow * rowHeight
        vaPriceTop    = lowestLow + (vaHigh + 1) * rowHeight
        box.new(leftBar, vaPriceTop, rightBar, vaPriceBottom, border_color=color.new(color.blue, 90), bgcolor=valueAreaBgColor)

        // Draw POC line
        pocPrice = lowestLow + (pocBin + 0.5) * rowHeight
        line.new(leftBar, pocPrice, rightBar, pocPrice, color=pocColor, width=2, style=line.style_dashed)
